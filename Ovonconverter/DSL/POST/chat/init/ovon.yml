assign_values:
  assign:
    request: ${incoming.body}

extractProtocolHeader:
  call: http.post
  args:
    url: "[#DMAPPER_URL]:[#DMAPPER_PORT]/convert/protocol-header"
    body:
      protocol: ${incoming.headers}
  result: convertedProtocol

assignProtocolVersion:
  assign:
    protocolVersion: ${convertedProtocol.response.body}

convertOvonToByk:
  call: http.post
  args:
    url: "[#DMAPPER_URL]:[#DMAPPER_PORT]/dmapper/ovonToByk-${protocolVersion}"
    body:
      request: ${request}
      type: "message"
      eventType: "invite"
      protocolVersion: ${incoming.headers.protocol}
  result: bykRequest

initChat:
  call: http.post
  args:
    url: https://ruuter.dev.buerokratt.ee/pub1/init-chat
    body:
      message: ${bykRequest.response.body.data.message}
      endUserTechnicalData: ${bykRequest.response.body.data.endUserTechnicalData}
  result: bykResult
  next: extractCookie

extractCookie:
  call: http.post
  args:
    url: "[#DMAPPER_URL]:[#DMAPPER_PORT]/convert/string/split"
    body:
      data: ${bykResult.response.headers['Set-Cookie'][0]}
      separator: ";"
  result: extractedCookie
  next: convertBykToOvon

convertBykToOvon:
  call: http.post
  args:
    url: "[#DMAPPER_URL]:[#DMAPPER_PORT]/dmapper/bykToOvon-${protocolVersion}"
    body:
      bykResponse: ${bykResult.response.body.data.get_inserted_chat}
      cookie: ${extractedCookie.response.body[0]}
      eventType: "init"
  result: ovonResult

returnSuccess:
  return: ${ovonResult.response.body}
  next: end